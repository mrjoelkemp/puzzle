// Generated by CoffeeScript 1.3.1
(function(){this.Piece=function(){function a(){}a.createPiece=function(a,b,c,d,e,f){var g;g=$("<canvas></canvas>").clone();g.attr({width:b,height:c,videox:d,videoy:e}).css("cursor","pointer").data("id",a).data("neighbors",f).data("group",-1).appendTo("#pieces-canvas").addClass("piece");return g};a.propagateSnap=function(a,b,c){var d,e=this;d=a.data("id");a.data("group",d);_.each(b,function(a){var b,f,g;f=a.data("group");b=f!==-1;if(b){g=e.getGroupObjects(f,a,c);return _.each(g,function(a){return a.data("group",d)})}});return _.each(b,function(a){return a.data("group",d)})};a.snapToNeighbors=function(a,b){var c,d,e,f=this;d=this.getNeighborRelations(a,b);e=_.zip(b,d);c=_.map(e,function(b){var c,d;c=b[0];d=b[1];return f.getSnappablePoints(a,c,d)});return _.each(c,function(b){var c,d,e;d=f.getMovementOffset(b[0],b[1],b[2],b[3]);c=d.left_offset;e=d.top_offset;return f.movePieceByOffsets(a,c,e,0)})};a.findSnappableNeighbors=function(a,b,c){var d,e,f,g,h,i,j,k,l,m;i=this.getNeighborRelations(a,b);j=[];h=_.map(b,function(a){return a.data("id")});for(d=l=0,m=h.length-1;0<=m?l<=m:l>=m;d=0<=m?++l:--l){e=h[d];f=b[d];g=i[d];k=this.canSnap(a,f,g,c);k&&j.push(e)}return j};a.canSnap=function(a,b,c,d){var e,f;e=this.getSnappablePoints(a,b,c);f=MathHelper.isWithinThreshold(e[0],e[1],e[2],e[3],d);return f};a.getSnappablePoints=function(a,b,c){var d,e,f;d=a.data("position");e=b.data("position");f=[];switch(c){case"right":f=[d.top_right,d.bottom_right,e.top_left,e.bottom_left];break;case"left":f=[d.top_left,d.bottom_left,e.top_right,e.bottom_right];break;case"top":f=[d.top_left,d.top_right,e.bottom_left,e.bottom_right];break;case"bottom":f=[d.bottom_left,d.bottom_right,e.top_left,e.top_right]}return f};a.onDragStart=function(a,b,c){return this.updateOldPosition(c,b.offset)};a.onDrag=function(a,b,c,d){var e,f,g;e={left:parseFloat(b.offset.left),top:parseFloat(b.offset.top)};g=c.data("group");f=g!==-1;f&&this.dragGroup(g,c,d,e);return this.updateOldPosition(c,b.offset)};a.dragGroup=function(a,b,c,d){var e,f,g,h=this;g=this.getGroupObjects(a,b,c);f=d.top-b.data("old_top");e=d.left-b.data("old_left");return _.each(g,function(a){var b,c,d,g;g=parseFloat(a.css("top"));d=parseFloat(a.css("left"));c=g+f;b=d+e;return a.css({top:c,left:b})})};a.updateDetailedPosition=function(a){var b,c,d,e,f,g,h,i,j,k;k=parseFloat(a.attr("width"));e=parseFloat(a.attr("height"));h=parseFloat(a.position().top);f=parseFloat(a.position().left);g=f+k;b=h+e;i={x:f,y:h};j={x:g,y:h};c={x:f,y:b};d={x:g,y:b};return a.data("position",{top_left:i,top_right:j,bottom_left:c,bottom_right:d})};a.updateOldPosition=function(a,b){a.data("old_top",parseFloat(b.top));return a.data("old_left",parseFloat(b.left))};a.setPositionByOffsets=function(a,b,c){var d,e,f,g;g=parseFloat(a.css("top"));d=parseFloat(a.css("left"));e=d+b;f=g+c;a.css("left",e);return a.css("top",f)};a.getMovementOffset=function(a,b,c,d){var e,f;f=c.y-a.y;e=d.x-b.x;return{top_offset:f,left_offset:e}};a.getGroupObjects=function(a,b,c){var d;d=_.filter(c,function(b){return b.data("group")===a});d=_.reject(d,function(a){return a.data("id")===b.data("id")});return d};a.getNeighborObjectsFromIds=function(a,b){var c;c=_.map(b,function(b){return a[b]});return c};a.getNeighborRelations=function(a,b){var c,d,e,f=this;c=a.data("neighbors");d=_.map(b,function(a){return a.data("id")});d=_.compact(d);e=_.map(d,function(a){return f.getKeyFromValue(c,a)});return e};a.getKeyFromValue=function(a,b){var c,d;d=_.keys(a);c=_.find(d,function(c){return a[c]===b});return c};a.getNeighborObjects=function(b,c){var d,e,f;e=b.data("neighbors");d=_.values(e);d=_.compact(d);f=a.getNeighborObjectsFromIds(c,d);return f};a.movePieceByOffsets=function(a,b,c,d){var e,f,g,h;d==null&&(d=0);f=parseFloat(a.css("top"));e=parseFloat(a.css("left"));g=e+b;h=f+c;return this.movePiece(a,g,h,d)};a.movePiece=function(a,b,c,d){d==null&&(d=1900);return a.animate({left:b,top:c},d)};return a}()}).call(this);